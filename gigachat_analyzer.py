# gigachat_analyzer.py
from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole
from gigachat.exceptions import GigaChatException
import logging
import json
import re
from config import config

logger = logging.getLogger(__name__)

class GigaChatAnalyzer:
    def __init__(self):
        self.api_key = config.GIGACHAT_API_KEY
        self.temperature = config.GIGACHAT_TEMPERATURE
        self.max_tokens = config.GIGACHAT_MAX_TOKENS
        self.model = config.GIGACHAT_MODEL
        self._client = None
    
    @property
    def client(self):
        if self._client is None:
            try:
                self._client = GigaChat(
                    credentials=self.api_key,
                    verify_ssl_certs=False,
                    timeout=60,
                    model=self.model
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
                self._client = None
        return self._client
    
    def analyze_speech(self, transcript_text, analysis_results, scenario=None):
        try:
            prompt, is_custom = self._build_prompt(transcript_text, analysis_results, scenario)

            if not self.client:
                logger.warning("GigaChat –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±—ç–∫")
                return self._get_fallback_feedback(analysis_results)

            temp = self.temperature
            if is_custom:
                temp = min(self.temperature, 0.2)

            system_msg = Messages(
                role=MessagesRole.SYSTEM,
                content=(
                    "–¢—ã ‚Äî –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π. "
                    "–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
                    "–û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏."
                )
            )

            user_msg = Messages(
                role=MessagesRole.USER,
                content=prompt
            )

            chat_request = Chat(
                messages=[system_msg, user_msg],
                temperature=temp,
                max_tokens=self.max_tokens,
                model=self.model
            )

            response = self.client.chat(chat_request)
            feedback = response.choices[0].message.content.strip()

            logger.info("‚úÖ –§–∏–¥–±—ç–∫ –æ—Ç GigaChat –ø–æ–ª—É—á–µ–Ω")
            return feedback
            
        except TypeError as e:
            logger.warning(f"–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å.")
            return self._simple_chat_request(prompt, analysis_results)
        except GigaChatException as e:
            logger.error(f"–û—à–∏–±–∫–∞ GigaChat API: {e}")
            return self._get_fallback_feedback(analysis_results)
        except Exception as e:
            logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            return self._get_fallback_feedback(analysis_results)
    
    def _simple_chat_request(self, prompt, analysis_results):
        try:
            with self.client as giga:
                response = giga.chat(prompt)
                feedback = response.choices[0].message.content.strip()
                logger.info("‚úÖ –§–∏–¥–±—ç–∫ –æ—Ç GigaChat –ø–æ–ª—É—á–µ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥)")
                return feedback
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return self._get_fallback_feedback(analysis_results)
    
    def _build_prompt(self, transcript_text, analysis_results, scenario=None):
        max_transcript_length = 3000
        if len(transcript_text) > max_transcript_length:
            transcript_preview = transcript_text[:max_transcript_length] + "... [—Ç–µ–∫—Å—Ç —Å–æ–∫—Ä–∞—â–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞]"
        else:
            transcript_preview = transcript_text

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è
        scenario_type = None
        scenario_text = None
        
        if scenario:
            if isinstance(scenario, dict):
                scenario_type = (scenario.get('type') or '').lower()
                scenario_text = scenario.get('text')
            else:
                scenario_type = str(scenario).lower()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —ç—Ç–æ custom –∏–ª–∏ –Ω–µ—Ç
        is_custom = scenario_type == 'custom'

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è
        if is_custom:
            # Custom-—Ä–µ–∂–∏–º: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
            tech_metrics = self._format_tech_metrics(analysis_results)
            
            prompt = f"""
–¢–´ –î–û–õ–ñ–ï–ù –°–¢–†–û–ì–û –°–õ–ï–î–û–í–ê–¢–¨ –≠–¢–û–ô –°–¢–†–£–ö–¢–£–†–ï:

1. –°–ù–ê–ß–ê–õ–ê –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –í–´–°–¢–£–ü–õ–ï–ù–ò–ï –ü–û –ö–†–ò–¢–ï–†–ò–Ø–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:

{scenario_text}


2. –ü–û–¢–û–ú –î–û–ë–ê–í–¨ –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ö–†–ò–¢–ï–†–ò–ò:

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–ï–¢–†–ò–ö–ò –†–ï–ß–ò:
üé§ –¢–µ–º–ø —Ä–µ—á–∏: {analysis_results.get('avg_tempo', 0):.1f} —Å–ª–æ–≤/—Å–µ–∫ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 3-5 —Å–ª–æ–≤/—Å–µ–∫)
‚è∏ –ü–∞—É–∑—ã (>1 —Å–µ–∫): {analysis_results.get('pauses_count', 0)} —à—Ç.
üó£ –°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã: {analysis_results.get('filler_words_count', 0)} —à—Ç.
üîÅ –ü–æ–≤—Ç–æ—Ä—ã (>3 —Ä–∞–∑): {analysis_results.get('repetitions_count', 0)} —Å–ª–æ–≤


3. –í –ö–û–ù–¶–ï –ù–ê–ü–ò–®–ò –í–´–í–û–î:

–í–´–í–û–î:
- [–ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è]
- [–ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ —Ä–µ—á–∏]
- [–û–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]


–¢–ï–ö–°–¢ –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
{transcript_preview}

–í–ê–ñ–ù–û: –ù–ï –î–£–ë–õ–ò–†–£–ô –ö–†–ò–¢–ï–†–ò–ò! –î–û–ë–ê–í–õ–Ø–ô –û–¶–ï–ù–ö–ò –ü–†–Ø–ú–û –ö –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú –°–¢–†–û–ö–ê–ú. –ò–°–ü–û–õ–¨–ó–£–ô –°–ú–ê–ô–õ–ò–ö–ò –î–õ–Ø –õ–£–ß–®–ï–ô –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò.
"""
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞–±–æ—Ç
            structure_templates = {
                'academic': {
                    'name': '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã',
                    'structure': """–û–ñ–ò–î–ê–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ê–ö–ê–î–ï–ú–ò–ß–ï–°–ö–û–ì–û –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø:
    1. –í–≤–µ–¥–µ–Ω–∏–µ (–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–æ–±–ª–µ–º–∞, —Ü–µ–ª—å —Ä–∞–±–æ—Ç—ã)
    2. –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä –∏–ª–∏ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞
    3. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
    4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑
    5. –í—ã–≤–æ–¥—ã –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π"""
                },
                'project': {
                    'name': '–ó–∞—â–∏—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞',
                    'structure': """–û–ñ–ò–î–ê–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ó–ê–©–ò–¢–´ –ü–†–û–ï–ö–¢–ê:
    1. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    2. –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    3. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ
    4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    5. –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    6. –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ (roadmap)"""
                },
                'hackathon': {
                    'name': '–•–∞–∫–∞—Ç–æ–Ω/–ø–∏—Ç—á',
                    'structure': """–û–ñ–ò–î–ê–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–ò–¢–ß-–í–´–°–¢–£–ü–õ–ï–ù–ò–Ø:
    1. –•—É–∫/–ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è (–ø–µ—Ä–≤—ã–µ 30 —Å–µ–∫—É–Ω–¥)
    2. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–±–æ–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏)
    3. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø—Ä–æ–¥—É–∫—Ç)
    4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –∏–ª–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
    5. –†–∞—Å—Å–∫–∞–∑ –æ –∫–æ–º–∞–Ω–¥–µ –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    6. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é"""
                },
                'public': {
                    'name': '–ü—É–±–ª–∏—á–Ω–æ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ',
                    'structure': """–û–ñ–ò–î–ê–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–£–ë–õ–ò–ß–ù–û–ì–û –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø:
    1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∞–Ω–æ–Ω—Å —Ç–µ–º—ã
    2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Ç–µ–∑–∏—Å–∞–º–∏
    3. –ü—Ä–∏–º–µ—Ä—ã, –∏—Å—Ç–æ—Ä–∏–∏, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
    4. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã
    5. –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (Q&A)"""
                }
            }
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
            template = structure_templates.get(scenario_type, structure_templates['academic'])
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤
            analysis_summary = f"""
    –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–ï–¢–†–ò–ö–ò:
    üïí –°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø —Ä–µ—á–∏: {analysis_results.get('avg_tempo', 0):.1f} —Å–ª–æ–≤/—Å–µ–∫
    ‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è: {analysis_results.get('total_duration', 0):.1f} —Å–µ–∫
    üó£ –í—Å–µ–≥–æ —Å–ª–æ–≤: {analysis_results.get('total_words', 0)}
    ‚è∏ –î–ª–∏–Ω–Ω—ã–µ –ø–∞—É–∑—ã (>1 —Å–µ–∫): {analysis_results.get('pauses_count', 0)}
    üí¨ –°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã: {analysis_results.get('filler_words_count', 0)}
    üîÅ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–ª–æ–≤–∞: {analysis_results.get('repetitions_count', 0)}
    """

            structure_analysis = f"""
    –¢–ò–ü –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø: {template['name']}
    
    {template['structure']}
    
    –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô, –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –õ–ò –í–´–°–¢–£–ü–õ–ï–ù–ò–ï –≠–¢–û–ô –°–¢–†–£–ö–¢–£–†–ï:
    1. –í—Å–µ –ª–∏ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç?
    2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–∞—Å–∫—Ä—ã—Ç—ã —Ä–∞–∑–¥–µ–ª—ã?
    3. –õ–æ–≥–∏—á–Ω—ã –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏?
    4. –ù–∞—Å–∫–æ–ª—å–∫–æ —á–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã?
    """

            prompt = f"""
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –ø—É–±–ª–∏—á–Ω—ã–º –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è–º —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–π, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–¥–±—ç–∫.

    –ö–û–ù–¢–ï–ö–°–¢:
    –≠—Ç–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ. –¶–µ–ª—å ‚Äî –ø–æ–º–æ—á—å —Å–ø–∏–∫–µ—Ä—É —É–ª—É—á—à–∏—Ç—å –Ω–∞–≤—ã–∫–∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π.

    –¢–ï–ö–°–¢ –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø:
    {transcript_preview}

    {analysis_summary}

    –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø:
    {structure_analysis}

    –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –û–¢–í–ï–¢–ê:
    1. –°–Ω–∞—á–∞–ª–∞ –¥–∞–π –æ—Ü–µ–Ω–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
    2. –ó–∞—Ç–µ–º –æ—Ü–µ–Ω–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã (—Ç–µ–º–ø, –ø–∞—É–∑—ã –∏ —Ç.–¥.)
    3. –ò—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    4. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
    5. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –¥–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

    # üéØ –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è

    ## üìä –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ä–º–∞—Ç—É: X/10
    [–¢–≤–æ—è –æ—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã]

    ## üìã –ü–æ–ª–Ω–æ—Ç–∞ —Ä–∞–∑–¥–µ–ª–æ–≤:
    - ‚úÖ [–†–∞–∑–¥–µ–ª 1]: [–æ—Ü–µ–Ω–∫–∞]
    - ‚ö†Ô∏è [–†–∞–∑–¥–µ–ª 2]: [–æ—Ü–µ–Ω–∫–∞]
    - ‚ùå [–†–∞–∑–¥–µ–ª 3]: [–æ—Ü–µ–Ω–∫–∞]

    ## üé§ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Ä–µ—á–∏:
    [–ê–Ω–∞–ª–∏–∑ —Ç–µ–º–ø–∞, –ø–∞—É–∑, —Å–ª–æ–≤-–ø–∞—Ä–∞–∑–∏—Ç–æ–≤]

    ## üí° –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
    1. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1]
    2. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2]
    3. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3]

    ## üèÜ –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: X/10
    [–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏ —Å–ª–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏]
    """
        
        return prompt, is_custom
    
    def _format_tech_metrics(self, analysis_results):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø—Ä–æ–º—Ç"""
        tempo = analysis_results.get('avg_tempo', 0)
        pauses = analysis_results.get('pauses_count', 0)
        fillers = analysis_results.get('filler_words_count', 0)
        repetitions = analysis_results.get('repetitions_count', 0)
        duration = analysis_results.get('total_duration', 0)
        words = analysis_results.get('total_words', 0)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ü–µ–Ω–∫—É —Ç–µ–º–ø–∞
        tempo_eval = "—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ" if tempo > 5 else "—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ" if tempo < 2 else "–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ü–µ–Ω–∫—É –ø–∞—É–∑
        pauses_eval = "–æ—á–µ–Ω—å –º–Ω–æ–≥–æ" if pauses > 10 else "–º–Ω–æ–≥–æ" if pauses > 5 else "–Ω–æ—Ä–º–∞–ª—å–Ω–æ" if pauses > 0 else "–æ—Ç–ª–∏—á–Ω–æ"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ü–µ–Ω–∫—É —Å–ª–æ–≤-–ø–∞—Ä–∞–∑–∏—Ç–æ–≤
        fillers_eval = "–æ—á–µ–Ω—å –º–Ω–æ–≥–æ" if fillers > 15 else "–º–Ω–æ–≥–æ" if fillers > 7 else "–Ω–æ—Ä–º–∞–ª—å–Ω–æ" if fillers > 0 else "–æ—Ç–ª–∏—á–Ω–æ"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ü–µ–Ω–∫—É –ø–æ–≤—Ç–æ—Ä–æ–≤
        reps_eval = "–º–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–æ–≤" if repetitions > 5 else "–Ω–µ–º–Ω–æ–≥–æ" if repetitions > 0 else "–æ—Ç–ª–∏—á–Ω–æ"
        
        return f"""
üé§ –¢–ï–ú–ü –†–ï–ß–ò:
‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å: {tempo:.1f} —Å–ª–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É ({tempo_eval} - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 3-5 —Å–ª–æ–≤/—Å–µ–∫)

‚è∏ –ü–ê–£–ó–´:
‚Ä¢ –î–ª–∏–Ω–Ω—ã–µ –ø–∞—É–∑—ã (>1 —Å–µ–∫—É–Ω–¥—ã): {pauses} ({pauses_eval})

üó£ –°–õ–û–í–ê-–ü–ê–†–ê–ó–ò–¢–´:
‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤-–ø–∞—Ä–∞–∑–∏—Ç–æ–≤: {fillers} ({fillers_eval})

üîÅ –ü–û–í–¢–û–†–´:
‚Ä¢ –°–ª–æ–≤, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –±–æ–ª–µ–µ 3 —Ä–∞–∑: {repetitions} ({reps_eval})

üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è: {duration:.1f} —Å–µ–∫—É–Ω–¥
‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω–æ —Å–ª–æ–≤: {words}
"""
    
    def _get_fallback_feedback(self, analysis_results):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–¥–±—ç–∫, –µ—Å–ª–∏ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
        tempo = analysis_results.get('avg_tempo', 0)
        pauses = analysis_results.get('pauses_count', 0)
        fillers = analysis_results.get('filler_words_count', 0)
        repetitions = analysis_results.get('repetitions_count', 0)
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É
        score = 10.0
        if tempo > 5: score -= 1.5
        if pauses > 5: score -= 1.0
        if fillers > 10: score -= 2.0
        if repetitions > 3: score -= 1.5
        if score < 3: score = 3.0
        
        feedback = f"""
# –û–¶–ï–ù–ö–ê –í–´–°–¢–£–ü–õ–ï–ù–ò–Ø (–ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- **–¢–µ–º–ø —Ä–µ—á–∏:** {tempo:.1f} —Å–ª–æ–≤/—Å–µ–∫ ({"—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ" if tempo > 5 else "–≤ –Ω–æ—Ä–º–µ" if tempo > 2 else "—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ"})
- **–ü–∞—É–∑—ã:** {pauses} –¥–ª–∏–Ω–Ω—ã—Ö –ø–∞—É–∑ (>1 —Å–µ–∫) - {"–º–Ω–æ–≥–æ" if pauses > 5 else "–Ω–æ—Ä–º–∞–ª—å–Ω–æ" if pauses > 0 else "–æ—Ç–ª–∏—á–Ω–æ"}
- **–°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã:** {fillers} —Å–ª–æ–≤ - {"–æ—á–µ–Ω—å –º–Ω–æ–≥–æ" if fillers > 15 else "–º–Ω–æ–≥–æ" if fillers > 7 else "–Ω–æ—Ä–º–∞–ª—å–Ω–æ" if fillers > 0 else "–æ—Ç–ª–∏—á–Ω–æ"}
- **–ü–æ–≤—Ç–æ—Ä—ã:** {repetitions} —Å–ª–æ–≤ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è >3 —Ä–∞–∑

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–º–ø 3-4 —Å–ª–æ–≤–∞ –≤ —Å–µ–∫—É–Ω–¥—É
2. –î–µ–ª–∞–π—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–∞—É–∑—ã –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞, –Ω–æ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–µ–∫—É–Ω–¥
3. –ó–∞–º–µ–Ω—è–π—Ç–µ —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã –Ω–∞ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –ø–∞—É–∑—ã
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–ª–æ–≤
5. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å —Å —Ç–∞–π–º–µ—Ä–æ–º –∏ –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–µ–±—è –Ω–∞ –≤–∏–¥–µ–æ

## üèÜ –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: {score:.1f}/10
–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Å–≤–æ–∏–º–∏ –Ω–∞–≤—ã–∫–∞–º–∏! –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.
"""
        
        return feedback

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
analyzer = GigaChatAnalyzer()