{% extends "base.html" %}

{% block title %}–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å - AI –¢—Ä–µ–Ω–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .progress-bar {
        transition: width 1s ease-in-out;
    }
    .suggestion-card {
        border-left: 4px solid;
        transition: all 0.3s;
    }
    .suggestion-card:hover {
        transform: translateX(5px);
    }
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞—É–¥–∏–æ –º–µ—Ç—Ä–∏–∫ */
    .audio-metric {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
            <p class="text-muted">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è</p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <!-- –í—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–æ–≤ -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100 border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-video fa-3x mb-3 text-primary"></i>
                    <h2 class="mb-1">{{ stats.total_analyses }}</h2>
                    <p class="text-muted mb-0">–ê–Ω–∞–ª–∏–∑–æ–≤</p>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100 border-success">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                    <h2 class="mb-1">{{ stats.exercises_completed }}</h2>
                    <p class="text-muted mb-0">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100 border-info">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-3x mb-3 text-info"></i>
                    <h2 class="mb-1">{{ stats.completion_rate|round(1) }}%</h2>
                    <p class="text-muted mb-0">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
                </div>
            </div>
        </div>

        <!-- –ù–û–í–û–ï: –≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏ -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100 audio-metric">
                <div class="card-body text-center">
                    <i class="fas fa-bolt fa-3x mb-3"></i>
                    {% if stats.avg_audio and stats.avg_audio.energy_score %}
                    <h2 class="mb-1">{{ stats.avg_audio.energy_score|round(1) }}</h2>
                    <p class="mb-0">–≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏</p>
                    <small>
                        {% if stats.avg_audio.energy_score < 40 %}
                            ‚ö†Ô∏è –ù–∏–∑–∫–∞—è
                        {% elif stats.avg_audio.energy_score < 60 %}
                            üìä –°—Ä–µ–¥–Ω—è—è
                        {% else %}
                            ‚úÖ –í—ã—Å–æ–∫–∞—è
                        {% endif %}
                    </small>
                    {% else %}
                    <h2 class="mb-1">-</h2>
                    <p class="mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- –¢–µ–º–ø -->
                        <div class="col-md-3 mb-3">
                            <h6 class="text-muted">–¢–µ–º–ø —Ä–µ—á–∏</h6>
                            <h4>{{ stats.avg_metrics.avg_tempo|round(1) }} —Å–ª–æ–≤/—Å–µ–∫</h4>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-{% if stats.avg_metrics.avg_tempo > 5 or stats.avg_metrics.avg_tempo < 2 %}danger{% else %}success{% endif %}" 
                                     style="width: {{ (stats.avg_metrics.avg_tempo / 6 * 100)|round }}%"></div>
                            </div>
                        </div>

                        <!-- –ü–∞—É–∑—ã -->
                        <div class="col-md-3 mb-3">
                            <h6 class="text-muted">–î–ª–∏–Ω–Ω—ã–µ –ø–∞—É–∑—ã</h6>
                            <h4>{{ stats.avg_metrics.pauses_count|round(1) }}</h4>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-{% if stats.avg_metrics.pauses_count > 5 %}warning{% else %}success{% endif %}" 
                                     style="width: {{ (stats.avg_metrics.pauses_count / 10 * 100)|round }}%"></div>
                            </div>
                        </div>

                        <!-- –°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã -->
                        <div class="col-md-3 mb-3">
                            <h6 class="text-muted">–°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã</h6>
                            <h4>{{ stats.avg_metrics.filler_words_count|round(1) }}</h4>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-{% if stats.avg_metrics.filler_words_count > 7 %}danger{% else %}success{% endif %}" 
                                     style="width: {{ (stats.avg_metrics.filler_words_count / 15 * 100)|round }}%"></div>
                            </div>
                        </div>

                        <!-- –ù–û–í–û–ï: –°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å -->
                        <div class="col-md-3 mb-3">
                            <h6 class="text-muted">–ì—Ä–æ–º–∫–æ—Å—Ç—å</h6>
                            {% if stats.avg_audio and stats.avg_audio.avg_volume %}
                            <h4>{{ stats.avg_audio.avg_volume|round(1) }}%</h4>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-{% if stats.avg_audio.avg_volume < 30 %}danger{% elif stats.avg_audio.avg_volume < 50 %}warning{% else %}success{% endif %}" 
                                     style="width: {{ stats.avg_audio.avg_volume }}%"></div>
                            </div>
                            {% else %}
                            <h4>-</h4>
                            <small class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
    {% if timeline %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h5>
                </div>
                <div class="card-body">
                    <canvas id="progressChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
    {% if suggestions %}
    <div class="row mb-4">
        <div class="col-12">
            <h4><i class="fas fa-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è</h4>
        </div>
    </div>
    <div class="row">
        {% for suggestion in suggestions %}
        <div class="col-md-6 mb-3">
            <div class="card suggestion-card border-{{ suggestion.color }}">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas {{ suggestion.icon }} text-{{ suggestion.color }}"></i>
                        {{ suggestion.title }}
                    </h5>
                    <p class="card-text">{{ suggestion.text }}</p>
                    <a href="{{ url_for('history') }}" class="btn btn-sm btn-outline-{{ suggestion.color }}">
                        –í—ã–±—Ä–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                    </a>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if timeline %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
const timelineData = {{ timeline|tojson }};
const labels = timelineData.map(item => item.date);
const tempoData = timelineData.map(item => item.tempo);
const pausesData = timelineData.map(item => item.pauses);
const fillersData = timelineData.map(item => item.fillers);

// –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
const energyData = timelineData.map(item => item.energy || null);

// –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
const ctx = document.getElementById('progressChart').getContext('2d');
const progressChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: '–¢–µ–º–ø (—Å–ª–æ–≤/—Å–µ–∫)',
                data: tempoData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4
            },
            {
                label: '–ü–∞—É–∑—ã',
                data: pausesData,
                borderColor: '#e67e22',
                backgroundColor: 'rgba(230, 126, 34, 0.1)',
                tension: 0.4
            },
            {
                label: '–°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã',
                data: fillersData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            },
            // –ù–û–í–û–ï: –õ–∏–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
            {
                label: '–≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏',
                data: energyData,
                borderColor: '#9b59b6',
                backgroundColor: 'rgba(155, 89, 182, 0.1)',
                tension: 0.4,
                borderDash: [5, 5]  // –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '–ó–Ω–∞—á–µ–Ω–∏–µ'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞'
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
