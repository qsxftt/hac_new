{% extends "base.html" %}

{% block title %}Результаты анализа - AI Тренер{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .nav-tabs .nav-link {
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    /* Стили для карточек графиков */
    .plot-card {
        transition: all 0.3s ease;
    }

    .plot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .plot-thumbnail {
        transition: transform 0.3s ease;
    }

    .plot-card:hover .plot-thumbnail {
        transform: scale(1.02);
    }

    /* Модальное окно */
    .image-modal {
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        overflow: hidden;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Кнопка закрытия */
    .modal-close {
        position: absolute;
        top: 20px;
        right: 40px;
        color: #fff;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10001;
        transition: color 0.3s;
    }

    .modal-close:hover {
        color: #ff6b6b;
    }

    /* Контейнер изображения */
    .modal-content-wrapper {
        position: relative;
        width: 100%;
        height: calc(100% - 120px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    /* Изображение в модальном окне */
    .modal-image {
        max-width: 95%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
        from { 
            transform: scale(0.8);
            opacity: 0;
        }
        to { 
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Подпись */
    .modal-caption {
        color: #fff;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        margin-top: 15px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }

    /* Счетчик */
    .modal-counter {
        color: #aaa;
        font-size: 14px;
        text-align: center;
        margin-top: 5px;
    }

    /* Стрелки навигации */
    .modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        font-size: 30px;
        padding: 15px 20px;
        cursor: pointer;
        z-index: 10001;
        transition: all 0.3s;
        border-radius: 5px;
    }

    .modal-nav:hover {
        background-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-50%) scale(1.1);
    }

    .modal-nav-left {
        left: 20px;
    }

    .modal-nav-right {
        right: 20px;
    }

    /* Миниатюры внизу */
    .modal-thumbnails {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100px;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 10px;
        overflow-x: auto;
    }

    .modal-thumbnail {
        height: 70px;
        width: auto;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 5px;
        transition: all 0.3s;
        opacity: 0.6;
    }

    .modal-thumbnail:hover {
        opacity: 1;
        border-color: #fff;
        transform: scale(1.1);
    }

    .modal-thumbnail.active {
        opacity: 1;
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }

    /* Скрыть scrollbar для миниатюр */
    .modal-thumbnails::-webkit-scrollbar {
        height: 5px;
    }

    .modal-thumbnails::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
    }

    .modal-thumbnails::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
    }

    .modal-thumbnails::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }

</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Заголовок -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-chart-bar"></i> Результаты анализа
                </h1>
                <p class="text-muted mb-0">
                    {{ analysis.video_filename }} • 
                    {{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}
                </p>
            </div>
            <div>
                <a href="{{ url_for('history') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Назад
                </a>
            </div>
        </div>

        <!-- Основные метрики -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card metric-card text-center h-100 
                    {% if metrics.get('avg_tempo', 0) > 5 %}border-danger
                    {% elif metrics.get('avg_tempo', 0) < 2 %}border-warning
                    {% else %}border-success{% endif %}">
                    <div class="card-body">
                        <i class="fas fa-tachometer-alt fa-2x mb-2 
                            {% if metrics.get('avg_tempo', 0) > 5 %}text-danger
                            {% elif metrics.get('avg_tempo', 0) < 2 %}text-warning
                            {% else %}text-success{% endif %}"></i>
                        <h3 class="mb-0">{{ metrics.get('avg_tempo', 0)|round(1) }}</h3>
                        <p class="text-muted mb-1">слов/сек</p>
                        <small class="text-muted">Средний темп</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card metric-card text-center h-100 
                    {% if metrics.get('pauses_count', 0) > 10 %}border-danger
                    {% elif metrics.get('pauses_count', 0) > 5 %}border-warning
                    {% else %}border-success{% endif %}">
                    <div class="card-body">
                        <i class="fas fa-pause-circle fa-2x mb-2 
                            {% if metrics.get('pauses_count', 0) > 10 %}text-danger
                            {% elif metrics.get('pauses_count', 0) > 5 %}text-warning
                            {% else %}text-success{% endif %}"></i>
                        <h3 class="mb-0">{{ metrics.get('pauses_count', 0) }}</h3>
                        <p class="text-muted mb-1">пауз > 1 сек</p>
                        <small class="text-muted">Длинные паузы</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card metric-card text-center h-100 
                    {% if metrics.get('filler_words_count', 0) > 15 %}border-danger
                    {% elif metrics.get('filler_words_count', 0) > 7 %}border-warning
                    {% else %}border-success{% endif %}">
                    <div class="card-body">
                        <i class="fas fa-comment-dots fa-2x mb-2 
                            {% if metrics.get('filler_words_count', 0) > 15 %}text-danger
                            {% elif metrics.get('filler_words_count', 0) > 7 %}text-warning
                            {% else %}text-success{% endif %}"></i>
                        <h3 class="mb-0">{{ metrics.get('filler_words_count', 0) }}</h3>
                        <p class="text-muted mb-1">слов</p>
                        <small class="text-muted">Слова-паразиты</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card metric-card text-center h-100 
                    {% if metrics.get('repetitions_count', 0) > 5 %}border-danger
                    {% else %}border-success{% endif %}">
                    <div class="card-body">
                        <i class="fas fa-redo fa-2x mb-2 
                            {% if metrics.get('repetitions_count', 0) > 5 %}text-danger
                            {% else %}text-success{% endif %}"></i>
                        <h3 class="mb-0">{{ metrics.get('repetitions_count', 0) }}</h3>
                        <p class="text-muted mb-1">слов > 3 раз</p>
                        <small class="text-muted">Повторы</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики -->
        {% if plots %}
        <div class="mb-4">
            <h3><i class="fas fa-chart-line"></i> Визуализация анализа</h3>
            <div class="row">
                {% for plot in plots %}
                <div class="col-md-6 mb-3">
                    <div class="card plot-card" style="cursor: pointer;" onclick="openImageModal({{ loop.index0 }})">
                        <div class="card-body">
                            <h6>{{ plot.replace('_plot.png', '').replace('_', ' ').title() }}</h6>
                            <img src="{{ url_for('serve_plot', filename=plot) }}" 
                                class="img-fluid plot-thumbnail" 
                                alt="{{ plot }}"
                                data-index="{{ loop.index0 }}"
                                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22%3EГрафик недоступен%3C/text%3E%3C/svg%3E';">
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-search-plus"></i> Нажмите для увеличения
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Модальное окно для просмотра графиков -->
        <div id="imageModal" class="image-modal" style="display: none;">
            <span class="modal-close" onclick="closeImageModal()">&times;</span>
            
            <!-- Стрелки навигации -->
            <button class="modal-nav modal-nav-left" onclick="navigateImage(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="modal-nav modal-nav-right" onclick="navigateImage(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Контейнер изображения -->
            <div class="modal-content-wrapper">
                <img class="modal-image" id="modalImage" src="" alt="График">
                <div class="modal-caption" id="modalCaption"></div>
                <div class="modal-counter" id="modalCounter"></div>
            </div>
            
            <!-- Миниатюры внизу -->
            <div class="modal-thumbnails" id="modalThumbnails">
                {% for plot in plots %}
                <img src="{{ url_for('serve_plot', filename=plot) }}" 
                    class="modal-thumbnail" 
                    data-index="{{ loop.index0 }}"
                    onclick="openImageModal({{ loop.index0 }})"
                    alt="{{ plot }}">
                {% endfor %}
            </div>
        </div>
        {% endif %}


        <!-- Вкладки с детальной информацией -->
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" 
                        data-bs-target="#feedback" type="button" role="tab">
                    <i class="fas fa-robot"></i> Фидбэк от AI
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transcript-tab" data-bs-toggle="tab" 
                        data-bs-target="#transcript" type="button" role="tab">
                    <i class="fas fa-file-alt"></i> Транскрипция
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-4" id="resultTabsContent">
            <!-- Фидбэк от AI -->
            <div class="tab-pane fade show active" id="feedback" role="tabpanel">
                {% if feedback %}
                    <div class="feedback-content">
                        {{ feedback|safe }}
                    </div>
                {% else %}
                    <div class="alert alert-secondary" role="alert">
                        <i class="fas fa-info-circle"></i> Фидбэк не найден
                    </div>
                {% endif %}
            </div>

            <!-- Транскрипция -->
            <div class="tab-pane fade" id="transcript" role="tabpanel">
                {% if transcript %}
                    <div class="transcript-content" style="white-space: pre-wrap; font-family: monospace;">{{ transcript }}</div>
                {% else %}
                    <div class="alert alert-secondary" role="alert">
                        <i class="fas fa-info-circle"></i> Транскрипция не найдена
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Кнопки действий -->

        <div class="mt-4 d-flex gap-2">
            <a href="{{ url_for('history') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> К истории
            </a>
            <a href="{{ url_for('trainer', analysis_id=analysis.id) }}" class="btn btn-success">
                <i class="fas fa-dumbbell"></i> Персональный тренажер
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> На главную
            </a>
        </div>
    </div>
</div>
<!-- JavaScript для галереи изображений -->
<script>
// Галерея изображений
let currentImageIndex = 0;
const plots = {{ plots|tojson }};

function openImageModal(index) {
    currentImageIndex = index;
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('modalCaption');
    const counter = document.getElementById('modalCounter');
    
    // Показываем модальное окно
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Блокируем прокрутку страницы
    
    // Устанавливаем изображение
    updateModalImage(index);
    
    // Обновляем активную миниатюру
    updateActiveThumbnail(index);
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Возвращаем прокрутку
}

function navigateImage(direction) {
    currentImageIndex += direction;
    
    // Зацикливание
    if (currentImageIndex < 0) {
        currentImageIndex = plots.length - 1;
    } else if (currentImageIndex >= plots.length) {
        currentImageIndex = 0;
    }
    
    updateModalImage(currentImageIndex);
    updateActiveThumbnail(currentImageIndex);
}

function updateModalImage(index) {
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('modalCaption');
    const counter = document.getElementById('modalCounter');
    
    // Создаем URL для изображения
    const plotName = plots[index];
    const imageUrl = "{{ url_for('serve_plot', filename='PLACEHOLDER') }}".replace('PLACEHOLDER', plotName);
    
    // Обновляем изображение с анимацией
    modalImg.style.animation = 'none';
    setTimeout(() => {
        modalImg.src = imageUrl;
        modalImg.style.animation = 'zoomIn 0.3s ease';
    }, 10);
    
    // Обновляем подпись
    const plotTitle = plotName.replace('_plot.png', '').replace(/_/g, ' ');
    caption.textContent = plotTitle.charAt(0).toUpperCase() + plotTitle.slice(1);
    
    // Обновляем счетчик
    counter.textContent = `${index + 1} / ${plots.length}`;
}

function updateActiveThumbnail(index) {
    const thumbnails = document.querySelectorAll('.modal-thumbnail');
    thumbnails.forEach((thumb, i) => {
        if (i === index) {
            thumb.classList.add('active');
            // Прокручиваем к активной миниатюре
            thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
            thumb.classList.remove('active');
        }
    });
}

// Обработка клавиш клавиатуры
document.addEventListener('keydown', function(event) {
    const modal = document.getElementById('imageModal');
    if (modal && modal.style.display === 'block') {
        if (event.key === 'ArrowLeft') {
            navigateImage(-1);
        } else if (event.key === 'ArrowRight') {
            navigateImage(1);
        } else if (event.key === 'Escape') {
            closeImageModal();
        }
    }
});

// Закрытие по клику вне изображения
const modalElement = document.getElementById('imageModal');
if (modalElement) {
    modalElement.addEventListener('click', function(event) {
        if (event.target === this) {
            closeImageModal();
        }
    });
}
</script>

{% endblock %}

