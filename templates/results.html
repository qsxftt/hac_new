<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты анализа - AI Тренер Выступлений</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2E86AB;
            --secondary-color: #A23B72;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #f8f9fa;
            padding-bottom: 50px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .plot-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .transcript-text {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Стили для фидбэка с поддержкой кастомного формата */
        .feedback-content {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 2rem;
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .feedback-content h1,
        .feedback-content h2,
        .feedback-content h3 {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .feedback-content h1 {
            font-size: 1.8rem;
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
        }
        
        .feedback-content h2 {
            font-size: 1.5rem;
            color: #4ECDC4;
        }
        
        .feedback-content h3 {
            font-size: 1.3rem;
            color: #FFD166;
        }
        
        /* Стили для кастомного формата */
        .criteria-item {
            background: rgba(67, 97, 238, 0.05);
            border-left: 4px solid #4361ee;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 0 8px 8px 0;
        }
        
        .criteria-section {
            font-weight: bold;
            color: #4ECDC4;
            margin: 1rem 0 0.5rem 0;
        }
        
        .subpoint {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
            color: #f8f9fa;
        }
        
        .evaluation-good {
            color: #06D6A0;
            font-weight: bold;
        }
        
        .evaluation-medium {
            color: #FFD166;
            font-weight: bold;
        }
        
        .evaluation-bad {
            color: #EF476F;
            font-weight: bold;
        }
        
        .tech-metrics-section {
            background: rgba(46, 134, 171, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
        }
        
        .conclusions-section {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid #06D6A0;
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
        }
        
        .feedback-content ul,
        .feedback-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .feedback-content li {
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }
        
        .feedback-content table {
            width: 100%;
            margin-bottom: 1.5rem;
            border-collapse: collapse;
        }
        
        .feedback-content table th,
        .feedback-content table td {
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }
        
        .feedback-content table th {
            background: rgba(46, 134, 171, 0.2);
            color: white;
        }
        
        .feedback-content table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .feedback-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1rem;
            margin-left: 0;
            font-style: italic;
            color: #aaa;
        }
        
        .tab-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 10px 10px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
        }
        
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs .nav-link {
            color: #ccc;
            border: none;
            border-radius: 0;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        
        .nav-tabs .nav-link.active {
            background: rgba(46, 134, 171, 0.2);
            color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .badge-tempo {
            background: linear-gradient(90deg, #2E86AB, #4ECDC4);
        }
        
        .badge-pauses {
            background: linear-gradient(90deg, #FF6B6B, #FFD166);
        }
        
        .badge-fillers {
            background: linear-gradient(90deg, #A23B72, #C73E1D);
        }
        
        .badge-repetitions {
            background: linear-gradient(90deg, #06D6A0, #118AB2);
        }
        
        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 32, 39, 0.95);
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }
        
        .scenario-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .scenario-academic {
            background: rgba(67, 97, 238, 0.2);
            color: #8ba0ff;
            border: 1px solid rgba(67, 97, 238, 0.3);
        }
        
        .scenario-project {
            background: rgba(114, 9, 183, 0.2);
            color: #c77dff;
            border: 1px solid rgba(114, 9, 183, 0.3);
        }
        
        .scenario-hackathon {
            background: rgba(247, 37, 133, 0.2);
            color: #ff87c3;
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .scenario-public {
            background: rgba(76, 201, 240, 0.2);
            color: #90e0ef;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .scenario-custom {
            background: rgba(255, 158, 0, 0.2);
            color: #ffc145;
            border: 1px solid rgba(255, 158, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>
                AI Тренер Выступлений
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i> Новый анализ
                </a>
                <a class="nav-link" href="/history">
                    <i class="fas fa-history me-1"></i> История
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Заголовок -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-1">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Результаты анализа
                </h1>
                <p class="text-muted mb-0">
                    Детальный разбор вашего выступления
                </p>
            </div>
            <div>
                <span class="badge bg-info me-2">
                    <i class="fas fa-clock me-1"></i>
                    {{ metrics.get('total_duration', 0)|round(1) }} сек
                </span>
                <span class="badge bg-secondary">
                    <i class="fas fa-file-word me-1"></i>
                    {{ metrics.get('total_words', 0) }} слов
                </span>
            </div>
        </div>

        <!-- Бейдж типа анализа -->
        {% if scenario and scenario.type %}
        <div class="mb-4">
            {% if scenario.type == 'academic' %}
                <span class="scenario-badge scenario-academic">
                    <i class="fas fa-graduation-cap me-1"></i> Академические работы
                </span>
            {% elif scenario.type == 'project' %}
                <span class="scenario-badge scenario-project">
                    <i class="fas fa-project-diagram me-1"></i> Защита проекта
                </span>
            {% elif scenario.type == 'hackathon' %}
                <span class="scenario-badge scenario-hackathon">
                    <i class="fas fa-lightbulb me-1"></i> Хакатон/питч
                </span>
            {% elif scenario.type == 'public' %}
                <span class="scenario-badge scenario-public">
                    <i class="fas fa-users me-1"></i> Публичное выступление
                </span>
            {% elif scenario.type == 'custom' %}
                <span class="scenario-badge scenario-custom">
                    <i class="fas fa-edit me-1"></i> Пользовательские критерии
                </span>
            {% endif %}
            
            {% if scenario.text and scenario.type != 'custom' %}
                <small class="text-muted ms-2">{{ scenario.text }}</small>
            {% endif %}
        </div>
        {% endif %}

        <!-- Основные метрики -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-tachometer-alt fa-2x mb-2 text-primary"></i>
                    <h6>Средний темп</h6>
                    <div class="metric-value">
                        {{ metrics.get('avg_tempo', 0)|round(1) }}
                    </div>
                    <small class="text-muted">слов/сек</small>
                    <div class="mt-2">
                        {% set tempo = metrics.get('avg_tempo', 0) %}
                        {% if tempo > 5 %}
                            <span class="badge bg-warning">Слишком быстро</span>
                        {% elif tempo < 2 %}
                            <span class="badge bg-warning">Слишком медленно</span>
                        {% else %}
                            <span class="badge bg-success">Оптимально</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-pause-circle fa-2x mb-2 text-warning"></i>
                    <h6>Длинные паузы</h6>
                    <div class="metric-value">
                        {{ metrics.get('pauses_count', 0) }}
                    </div>
                    <small class="text-muted">пауз > 1 сек</small>
                    <div class="mt-2">
                        {% set pauses = metrics.get('pauses_count', 0) %}
                        {% if pauses > 10 %}
                            <span class="badge bg-danger">Очень много</span>
                        {% elif pauses > 5 %}
                            <span class="badge bg-warning">Много</span>
                        {% elif pauses > 0 %}
                            <span class="badge bg-info">Нормально</span>
                        {% else %}
                            <span class="badge bg-success">Отлично</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-comment-slash fa-2x mb-2 text-danger"></i>
                    <h6>Слова-паразиты</h6>
                    <div class="metric-value">
                        {{ metrics.get('filler_words_count', 0) }}
                    </div>
                    <small class="text-muted">слов</small>
                    <div class="mt-2">
                        {% set fillers = metrics.get('filler_words_count', 0) %}
                        {% if fillers > 15 %}
                            <span class="badge bg-danger">Очень много</span>
                        {% elif fillers > 7 %}
                            <span class="badge bg-warning">Много</span>
                        {% elif fillers > 0 %}
                            <span class="badge bg-info">Немного</span>
                        {% else %}
                            <span class="badge bg-success">Отлично</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-redo fa-2x mb-2 text-info"></i>
                    <h6>Повторы</h6>
                    <div class="metric-value">
                        {{ metrics.get('repetitions_count', 0) }}
                    </div>
                    <small class="text-muted">слов > 3 раз</small>
                    <div class="mt-2">
                        {% set reps = metrics.get('repetitions_count', 0) %}
                        {% if reps > 5 %}
                            <span class="badge bg-warning">Много повторов</span>
                        {% elif reps > 0 %}
                            <span class="badge bg-info">Немного</span>
                        {% else %}
                            <span class="badge bg-success">Отлично</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики -->
        {% if plots %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Визуализация анализа
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for plot in plots %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="plot-container">
                                    <img src="{{ url_for('serve_plot', filename=plot) }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ plot }}"
                                         style="cursor: pointer;"
                                         onclick="openModal('{{ url_for('serve_plot', filename=plot) }}')">
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">
                                            {{ plot.replace('_plot.png', '').replace('_', ' ').title() }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Вкладки с дополнительной информацией -->
        <div class="row mb-5">
            <div class="col-12">
                <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" 
                                data-bs-target="#feedback" type="button">
                            <i class="fas fa-comment-dots me-1"></i> Фидбэк от AI
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transcript-tab" data-bs-toggle="tab" 
                                data-bs-target="#transcript" type="button">
                            <i class="fas fa-file-alt me-1"></i> Транскрипция
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab" 
                                data-bs-target="#details" type="button">
                            <i class="fas fa-info-circle me-1"></i> Детали
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="resultsTabsContent">
                    <!-- Фидбэк -->
                    <div class="tab-pane fade show active" id="feedback" role="tabpanel">
                        <div class="feedback-content">
                            {% if feedback %}
                                {{ feedback|safe }}
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Фидбэк не найден. Возможно, анализ еще выполняется.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Транскрипция -->
                    <div class="tab-pane fade" id="transcript" role="tabpanel">
                        {% if transcript %}
                            <div class="transcript-text">
                                {{ transcript|replace('\n', '<br>')|safe }}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-file-alt fa-3x mb-3"></i>
                                <p>Транскрипция не найдена</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Детали -->
                    <div class="tab-pane fade" id="details" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Общая статистика</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                                        <span>Длительность выступления:</span>
                                        <strong>{{ metrics.get('total_duration', 0)|round(1) }} сек</strong>
                                    </li>
                                    <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                                        <span>Всего слов:</span>
                                        <strong>{{ metrics.get('total_words', 0) }}</strong>
                                    </li>
                                    <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                                        <span>Средняя длина слова:</span>
                                        <strong>
                                            {% if metrics.get('total_words', 0) > 0 %}
                                                {{ (metrics.get('total_chars', 0)|default(0) / metrics.get('total_words', 1))|round(1) }}
                                            {% else %}0{% endif %} симв.
                                        </strong>
                                    </li>
                                    <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                                        <span>Проблемы с темпом:</span>
                                        <strong class="{{ 'text-warning' if metrics.get('speed_issues_count', 0) > 0 else 'text-success' }}">
                                            {{ metrics.get('speed_issues_count', 0) }}
                                        </strong>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Рекомендации</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    {{ metrics.get('details', 'Анализ завершен успешно!') }}
                                </div>
                                
                                <h6 class="mt-3">Что улучшить?</h6>
                                <ul class="list-group list-group-flush">
                                    {% if metrics.get('avg_tempo', 0) > 5 %}
                                        <li class="list-group-item bg-transparent text-light border-secondary">
                                            <i class="fas fa-running text-warning me-2"></i>
                                            Снизьте темп речи до 3-4 слов/сек
                                        </li>
                                    {% endif %}
                                    {% if metrics.get('pauses_count', 0) > 5 %}
                                        <li class="list-group-item bg-transparent text-light border-secondary">
                                            <i class="fas fa-pause text-warning me-2"></i>
                                            Сократите паузы длиннее 1 секунды
                                        </li>
                                    {% endif %}
                                    {% if metrics.get('filler_words_count', 0) > 7 %}
                                        <li class="list-group-item bg-transparent text-light border-secondary">
                                            <i class="fas fa-ban text-warning me-2"></i>
                                            Практикуйтесь без слов-паразитов
                                        </li>
                                    {% endif %}
                                    {% if metrics.get('repetitions_count', 0) > 3 %}
                                        <li class="list-group-item bg-transparent text-light border-secondary">
                                            <i class="fas fa-sync-alt text-warning me-2"></i>
                                            Используйте синонимы вместо повторов
                                        </li>
                                    {% endif %}
                                    {% if metrics.get('speed_issues_count', 0) > 0 %}
                                        <li class="list-group-item bg-transparent text-light border-secondary">
                                            <i class="fas fa-chart-line text-info me-2"></i>
                                            Контролируйте равномерность темпа
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопки действий (фиксированные внизу) -->
    <div class="action-buttons">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-center">
                        <a href="/" class="btn btn-primary me-3">
                            <i class="fas fa-upload me-1"></i> Новый анализ
                        </a>
                        <a href="/history" class="btn btn-secondary me-3">
                            <i class="fas fa-history me-1"></i> История
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-light me-3">
                            <i class="fas fa-print me-1"></i> Печать
                        </button>
                        <button onclick="exportResults()" class="btn btn-success">
                            <i class="fas fa-download me-1"></i> Экспорт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для графиков -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр графика</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="">
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function openModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }
        
        function exportResults() {
            const data = {
                metrics: {{ metrics|tojson }},
                transcript: `{{ transcript|tojson }}`,
                feedback: `{{ raw_feedback|tojson }}`,
                date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `speech-analysis-${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const text = `РЕЗУЛЬТАТЫ АНАЛИЗА ВЫСТУПЛЕНИЯ\n` +
                        `================================\n\n` +
                        `Дата анализа: ${new Date().toLocaleString()}\n` +
                        `Длительность: {{ metrics.get('total_duration', 0)|round(1) }} сек\n` +
                        `Всего слов: {{ metrics.get('total_words', 0) }}\n` +
                        `Средний темп: {{ metrics.get('avg_tempo', 0)|round(1) }} слов/сек\n` +
                        `Паузы (>1 сек): {{ metrics.get('pauses_count', 0) }}\n` +
                        `Слова-паразиты: {{ metrics.get('filler_words_count', 0) }}\n` +
                        `Повторы: {{ metrics.get('repetitions_count', 0) }}\n\n` +
                        `ФИДБЭК:\n{{ raw_feedback }}\n\n` +
                        `ТРАНСКРИПЦИЯ:\n{{ transcript }}`;
            
            const textBlob = new Blob([text], { type: 'text/plain' });
            const textUrl = URL.createObjectURL(textBlob);
            const textA = document.createElement('a');
            textA.href = textUrl;
            textA.download = `speech-analysis-${new Date().getTime()}.txt`;
            document.body.appendChild(textA);
            textA.click();
            document.body.removeChild(textA);
            URL.revokeObjectURL(textUrl);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const firstTab = new bootstrap.Tab(document.getElementById('feedback-tab'));
            firstTab.show();
            
            const tabTriggers = [].slice.call(document.querySelectorAll('#resultsTabs button'));
            tabTriggers.forEach(function(trigger) {
                trigger.addEventListener('click', function(event) {
                    event.preventDefault();
                    const tab = new bootstrap.Tab(this);
                    tab.show();
                });
            });
        });
    </script>
</body>
</html>