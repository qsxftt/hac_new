{% extends "base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ - AI –¢—Ä–µ–Ω–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    /* –ù–û–í–´–ô CSS –î–õ–Ø –ê–£–î–ò–û –ú–ï–¢–†–ò–ö */
    .metric-box {
        padding: 20px;
        border-radius: 8px;
        background: #f8f9fa;
        transition: transform 0.2s;
    }

    .metric-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .metric-box h3 {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .nav-tabs .nav-link {
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    .plot-card {
        transition: all 0.3s ease;
    }
    .plot-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .clickable-image {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .clickable-image:hover {
        transform: scale(1.02);
    }
    
    #imageModal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }
    
    #imageModal img {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
    }
    
    .modal-close {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        padding: 20px;
    }
    
    .modal-nav:hover {
        color: #bbb;
    }
    
    #modalPrev {
        left: 20px;
    }
    
    #modalNext {
        right: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h1>
            <p class="text-muted">
                <i class="fas fa-video"></i> {{ analysis.video_filename }} ‚Ä¢ 
                <i class="far fa-clock"></i> {{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}
            </p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100 border-{% if metrics.avg_tempo > 5 or metrics.avg_tempo < 2 %}danger{% else %}success{% endif %}">
                <div class="card-body text-center">
                    <i class="fas fa-tachometer-alt fa-3x mb-3 text-{% if metrics.avg_tempo > 5 or metrics.avg_tempo < 2 %}danger{% else %}success{% endif %}"></i>
                    <h3 class="mb-1">{{ metrics.avg_tempo|round(1) }}</h3>
                    <p class="text-muted mb-0">—Å–ª–æ–≤/—Å–µ–∫</p>
                    <small class="text-muted">–°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100 border-{% if metrics.pauses_count > 5 %}warning{% else %}success{% endif %}">
                <div class="card-body text-center">
                    <i class="fas fa-pause-circle fa-3x mb-3 text-{% if metrics.pauses_count > 5 %}warning{% else %}success{% endif %}"></i>
                    <h3 class="mb-1">{{ metrics.pauses_count }}</h3>
                    <p class="text-muted mb-0">–ø–∞—É–∑ > 1 —Å–µ–∫</p>
                    <small class="text-muted">–î–ª–∏–Ω–Ω—ã–µ –ø–∞—É–∑—ã</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100 border-{% if metrics.filler_words_count > 7 %}danger{% else %}success{% endif %}">
                <div class="card-body text-center">
                    <i class="fas fa-comment-dots fa-3x mb-3 text-{% if metrics.filler_words_count > 7 %}danger{% else %}success{% endif %}"></i>
                    <h3 class="mb-1">{{ metrics.filler_words_count }}</h3>
                    <p class="text-muted mb-0">—Å–ª–æ–≤</p>
                    <small class="text-muted">–°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100 border-{% if metrics.repetitions_count > 5 %}warning{% else %}success{% endif %}">
                <div class="card-body text-center">
                    <i class="fas fa-redo fa-3x mb-3 text-{% if metrics.repetitions_count > 5 %}warning{% else %}success{% endif %}"></i>
                    <h3 class="mb-1">{{ metrics.repetitions_count }}</h3>
                    <p class="text-muted mb-0">—Å–ª–æ–≤ > 3 —Ä–∞–∑</p>
                    <small class="text-muted">–ü–æ–≤—Ç–æ—Ä—ã</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ê–£–î–ò–û –ê–ù–ê–õ–ò–ó ========== -->
    {% if metrics.get('audio_features') or (analysis.result and analysis.result.get_audio_features()) %}
    {% set audio = metrics.get('audio_features') or analysis.result.get_audio_features() %}
    {% if audio and audio.get('energy_score') %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-microphone"></i> üé§ –ê—É–¥–∏–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–µ—á–∏</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- –≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏ -->
                        <div class="col-md-4 mb-3">
                            <div class="metric-box">
                                <i class="fas fa-bolt fa-3x mb-2 text-{% if audio.energy_score < 40 %}danger{% elif audio.energy_score < 60 %}warning{% else %}success{% endif %}"></i>
                                <h3 class="mb-1">{{ audio.energy_score|round(1) }}/100</h3>
                                <p class="text-muted mb-0">–≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏</p>
                                <small class="text-muted">
                                    {% if audio.energy_score < 40 %}
                                        ‚ö†Ô∏è –ù–∏–∑–∫–∞—è - –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ
                                    {% elif audio.energy_score < 60 %}
                                        üìä –°—Ä–µ–¥–Ω—è—è - –º–æ–∂–Ω–æ –ª—É—á—à–µ
                                    {% else %}
                                        ‚úÖ –í—ã—Å–æ–∫–∞—è - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <!-- –°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å -->
                        <div class="col-md-4 mb-3">
                            <div class="metric-box">
                                <i class="fas fa-volume-up fa-3x mb-2 text-{% if audio.avg_volume < 30 %}danger{% elif audio.avg_volume < 50 %}warning{% else %}success{% endif %}"></i>
                                <h3 class="mb-1">{{ audio.avg_volume|round(1) }}%</h3>
                                <p class="text-muted mb-0">–°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å</p>
                                <small class="text-muted">
                                    {% if audio.avg_volume < 30 %}
                                        üîá –°–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ
                                    {% elif audio.avg_volume < 50 %}
                                        üîâ –¢–∏—Ö–æ
                                    {% else %}
                                        üîä –•–æ—Ä–æ—à–æ
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <!-- –í–∞—Ä–∏–∞—Ü–∏—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ -->
                        <div class="col-md-4 mb-3">
                            <div class="metric-box">
                                <i class="fas fa-wave-square fa-3x mb-2 text-{% if audio.pitch_variance < 200 %}danger{% elif audio.pitch_variance < 500 %}warning{% else %}success{% endif %}"></i>
                                <h3 class="mb-1">{{ audio.pitch_variance|round(0) }}</h3>
                                <p class="text-muted mb-0">–í–∞—Ä–∏–∞—Ü–∏—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏</p>
                                <small class="text-muted">
                                    {% if audio.pitch_variance < 200 %}
                                        üò¥ –ú–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è
                                    {% elif audio.pitch_variance < 500 %}
                                        üìà –£–º–µ—Ä–µ–Ω–Ω–∞—è
                                    {% else %}
                                        üé≠ –í—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–∞—è
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—É–¥–∏–æ -->
                    <div class="alert alert-info mt-3" role="alert">
                        <i class="fas fa-lightbulb"></i> <strong>–°–æ–≤–µ—Ç:</strong>
                        {% if audio.energy_score < 40 %}
                            –¢–≤–æ—è —Ä–µ—á—å –∑–≤—É—á–∏—Ç –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ –∏ —Ç–∏—Ö–æ. –†–∞–±–æ—Ç–∞–π –Ω–∞–¥ –≥—Ä–æ–º–∫–æ—Å—Ç—å—é –∏ –¥–æ–±–∞–≤—å —ç–º–æ—Ü–∏–π! –ü–æ–ø—Ä–æ–±—É–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –¥—ã—Ö–∞–Ω–∏–µ –∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢—Ä–µ–Ω–∞–∂–µ—Ä".
                        {% elif audio.energy_score < 60 %}
                            –ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏! –ü—Ä–∞–∫—Ç–∏–∫—É–π –≤–∞—Ä–∏–∞—Ü–∏—é –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞–π –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ü–∏–µ–π –≥–æ–ª–æ—Å–∞.
                        {% else %}
                            –û—Ç–ª–∏—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏! –¢–≤–æ—ë –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∑–≤—É—á–∏—Ç –∂–∏–≤–æ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- –í–°–ï –ì–†–ê–§–ò–ö–ò -->
    <div class="row mt-4">
        <div class="col-12">
            <h4><i class="fas fa-chart-bar"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h4>
        </div>
    </div>

    {% if plots %}
    <div class="row mt-3">
        {% for plot in plots %}
        <div class="col-md-6 mb-4">
            <div class="card plot-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        {% if 'tempo' in plot %}
                            üìà –¢–µ–º–ø —Ä–µ—á–∏
                        {% elif 'pause' in plot %}
                            ‚è∏Ô∏è –ü–∞—É–∑—ã
                        {% elif 'filler' in plot %}
                            üí¨ –°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã
                        {% elif 'summary' in plot %}
                            üìä –°–≤–æ–¥–∫–∞
                        {% elif 'volume' in plot %}
                            üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å —Ä–µ—á–∏
                        {% elif 'pitch' in plot %}
                            üéµ –ò–Ω—Ç–æ–Ω–∞—Ü–∏—è —Ä–µ—á–∏
                        {% elif 'energy' in plot %}
                            üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏
                        {% else %}
                            üìä {{ plot }}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ url_for('serve_plot', filename=plot) }}" 
                         alt="{{ plot }}" 
                         class="img-fluid clickable-image" 
                         data-plot="{{ plot }}"
                         style="cursor: pointer; max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –§–∏–¥–±—ç–∫ –æ—Ç GigaChat -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> –§–∏–¥–±—ç–∫ –æ—Ç AI</h5>
                </div>
                <div class="card-body">
                    <div class="feedback-content">
                        {{ feedback|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt"></i> –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h5>
                </div>
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px;">{{ transcript }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="row mt-4 mb-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('trainer', analysis_id=analysis.id) }}" class="btn btn-success btn-lg">
                <i class="fas fa-dumbbell"></i> –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–Ω–∞–∂–µ—Ä
            </a>
            <a href="{{ url_for('history') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-history"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏—Å—Ç–æ—Ä–∏–∏
            </a>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="imageModal">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <span class="modal-nav" id="modalPrev" onclick="navigateImage(-1)">&#10094;</span>
    <img id="modalImage" src="" alt="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
    <span class="modal-nav" id="modalNext" onclick="navigateImage(1)">&#10095;</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
// –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
const allPlots = {{ plots|tojson }};
let currentImageIndex = 0;

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const filename = imageSrc.split('/').pop();
    currentImageIndex = allPlots.indexOf(filename);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
function navigateImage(direction) {
    currentImageIndex += direction;
    
    // –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
    if (currentImageIndex < 0) {
        currentImageIndex = allPlots.length - 1;
    } else if (currentImageIndex >= allPlots.length) {
        currentImageIndex = 0;
    }
    
    const modalImg = document.getElementById('modalImage');
    modalImg.src = "{{ url_for('serve_plot', filename='') }}" + allPlots[currentImageIndex];
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.clickable-image');
    images.forEach(function(img) {
        img.addEventListener('click', function() {
            openImageModal(this.src);
        });
    });
    
    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('imageModal');
        if (modal.style.display === 'block') {
            if (event.key === 'ArrowLeft') {
                navigateImage(-1);
            } else if (event.key === 'ArrowRight') {
                navigateImage(1);
            } else if (event.key === 'Escape') {
                closeImageModal();
            }
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const modalElement = document.getElementById('imageModal');
    if (modalElement) {
        modalElement.addEventListener('click', function(event) {
            if (event.target === this) {
                closeImageModal();
            }
        });
    }
});
</script>
{% endblock %}
