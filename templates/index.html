{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - AI –¢—Ä–µ–Ω–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .pwa-install-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        gap: 15px;
    }
    
    .pwa-install-banner i {
        font-size: 2rem;
    }
    
    .pwa-install-text {
        flex: 1;
    }
    
    .pwa-install-text h4 {
        margin: 0 0 5px 0;
        font-weight: 600;
    }
    
    .pwa-install-text p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }
    
    .pwa-install-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s;
    }
    
    .pwa-install-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .pwa-install-banner.hidden {
        display: none;
    }

    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    .upload-zone {
        border: 3px dashed #007bff;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }
    .upload-zone:hover {
        background: #e9ecef;
        border-color: #0056b3;
    }
    .upload-zone.dragover {
        background: #d1ecf1;
        border-color: #17a2b8;
    }
    .scenario-card {
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .scenario-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .scenario-card.selected {
        border-color: #007bff;
        background-color: #e7f3ff;
    }
    .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    /* 5 –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ —Å—Ç—Ä–æ–∫–µ */
    .col-md-2-4 {
        flex: 0 0 calc(20% - 0.75rem);
        max-width: calc(20% - 0.75rem);
    }
    @media (max-width: 1200px) {
        .col-md-2-4 {
            flex: 0 0 calc(25% - 0.75rem);
            max-width: calc(25% - 0.75rem);
        }
    }
    @media (max-width: 768px) {
        .col-md-2-4 {
            flex: 0 0 calc(50% - 0.75rem);
            max-width: calc(50% - 0.75rem);
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- PWA Install Banner -->
<div id="pwaInstallBanner" class="pwa-install-banner hidden">
    <div>
        <i class="fas fa-mobile-alt"></i>
    </div>
    <div class="pwa-install-text">
        <h4>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h4>
        <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NeuroSpeech –Ω–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω!</p>
    </div>
    <button class="pwa-install-btn" id="pwaInstallButtonHeader">
        <i class="fas fa-download"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="btn-close btn-close-white" type="button" onclick="document.getElementById('pwaInstallBanner').classList.add('hidden')"></button>
</div>

{% if current_user.is_authenticated %}
<!-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
        </h1>

        <form id="uploadForm" method="POST" action="{{ url_for('analyze') }}" enctype="multipart/form-data">
            <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="upload-zone mb-4" id="uploadZone">
                <input type="file" 
                       name="video" 
                       id="videoInput" 
                       accept=".mp4,.avi,.mov,.mkv,.webm" 
                       style="display: none;" 
                       required>
                <i class="fas fa-cloud-upload-alt feature-icon text-primary"></i>
                <h4>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞</h4>
                <p class="text-muted mb-3">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('videoInput').click()">
                    <i class="fas fa-folder-open"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </button>
                <p class="text-muted small mt-3 mb-0">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, MKV, WebM (–º–∞–∫—Å. 100 –ú–ë)
                </p>
            </div>

            <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª -->
            <div id="fileInfo" class="alert alert-info" style="display: none;">
                <i class="fas fa-file-video"></i> 
                <strong>–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:</strong> <span id="fileName"></span>
                <button type="button" class="btn-close float-end" onclick="clearFile()"></button>
            </div>

            <!-- –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è -->
            <h4 class="mb-3">
                <i class="fas fa-tasks"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è:
            </h4>

            <input type="hidden" name="scenario" id="scenarioInput" value="academic">

            <div class="row mb-4">
                <div class="col-md-2-4 mb-3">
                    <div class="card scenario-card selected" data-scenario="academic">
                        <div class="card-body text-center">
                            <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                            <h5>–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</h5>
                            <p class="text-muted small">–ó–∞—â–∏—Ç–∞ –¥–∏–ø–ª–æ–º–æ–≤, –∫—É—Ä—Å–æ–≤—ã—Ö, –¥–∏—Å—Å–µ—Ä—Ç–∞—Ü–∏–π</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-2-4 mb-3">
                    <div class="card scenario-card" data-scenario="project">
                        <div class="card-body text-center">
                            <i class="fas fa-project-diagram fa-3x text-success mb-3"></i>
                            <h5>–ó–∞—â–∏—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞</h5>
                            <p class="text-muted small">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–∞–ø–∞, –±–∏–∑–Ω–µ—Å-–ø—Ä–æ–µ–∫—Ç–∞</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-2-4 mb-3">
                    <div class="card scenario-card" data-scenario="hackathon">
                        <div class="card-body text-center">
                            <i class="fas fa-rocket fa-3x text-warning mb-3"></i>
                            <h5>–•–∞–∫–∞—Ç–æ–Ω/–ø–∏—Ç—á</h5>
                            <p class="text-muted small">–ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –ø–∏—Ç—á–∏–Ω–≥ –∏–¥–µ–∏</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-2-4 mb-3">
                    <div class="card scenario-card" data-scenario="public">
                        <div class="card-body text-center">
                            <i class="fas fa-microphone fa-3x text-info mb-3"></i>
                            <h5>–ü—É–±–ª–∏—á–Ω–æ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h5>
                            <p class="text-muted small">–î–æ–∫–ª–∞–¥—ã, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –ª–µ–∫—Ü–∏–∏</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-2-4 mb-3">
                    <div class="card scenario-card" data-scenario="custom">
                        <div class="card-body text-center">
                            <i class="fas fa-edit fa-3x text-danger mb-3"></i>
                            <h5>–°–≤–æ–∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏</h5>
                            <p class="text-muted small">–ó–∞–¥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å–≤–æ–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ -->
            <div id="customCriteriaBox" style="display: none;" class="card mb-4">
                <div class="card-body">
                    <label for="customCriteria" class="form-label">
                        <strong>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</strong>
                    </label>
                    <textarea class="form-control" 
                              name="custom_criteria" 
                              id="customCriteria" 
                              rows="5" 
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:&#10;1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è&#10;2. –ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è&#10;3. –ö–æ–Ω—Ç–∞–∫—Ç —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π"></textarea>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                    <i class="fas fa-paper-plane"></i> –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                </button>
            </div>
        </form>
    </div>
</div>

{% else %}
<!-- –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö - landing page -->

<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 mb-4">
            <i class="fas fa-microphone-alt"></i> AI –¢—Ä–µ–Ω–µ—Ä –í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π
        </h1>
        <p class="lead mb-4">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ —Å–≤–æ–µ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ—á–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        </p>
        <div class="d-flex gap-3 justify-content-center">
            <a href="{{ url_for('auth.register') }}" class="btn btn-light btn-lg">
                <i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light btn-lg">
                <i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-video feature-icon text-primary"></i>
            <h4>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ</h4>
            <p class="text-muted">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-brain feature-icon text-success"></i>
            <h4>AI –∞–Ω–∞–ª–∏–∑</h4>
            <p class="text-muted">–¢–µ–º–ø, –ø–∞—É–∑—ã, —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-chart-line feature-icon text-warning"></i>
            <h4>–î–µ—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</h4>
            <p class="text-muted">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-dumbbell feature-icon text-info"></i>
            <h4>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h4>
            <p class="text-muted">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
        </div>
    </div>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
{% if current_user.is_authenticated %}
<script>
console.log('[INIT] Upload form script loaded');

document.addEventListener('DOMContentLoaded', function() {
    console.log('[DOMContentLoaded] DOM loaded');
    
    const videoInput = document.getElementById('videoInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const uploadZone = document.getElementById('uploadZone');

    console.log('[Elements]', {
        videoInput: !!videoInput,
        fileInfo: !!fileInfo,
        fileName: !!fileName,
        submitBtn: !!submitBtn,
        uploadZone: !!uploadZone
    });

    if (!videoInput || !fileInfo || !fileName || !submitBtn || !uploadZone) {
        console.error('[ERROR] Form elements not found');
        return;
    }

    // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    uploadZone.addEventListener('click', () => {
        console.log('[Event] Upload zone clicked');
        videoInput.click();
    });

    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    videoInput.addEventListener('change', (e) => {
        console.log('[Event] File changed:', e.target.files[0]?.name);
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            submitBtn.disabled = false;
        }
    });

    // Drag & Drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
            videoInput.files = e.dataTransfer.files;
            const file = e.dataTransfer.files[0];
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            submitBtn.disabled = false;
        }
    });

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞
    window.clearFile = function() {
        videoInput.value = '';
        fileInfo.style.display = 'none';
        submitBtn.disabled = true;
    };

    // –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è
    const scenarioCards = document.querySelectorAll('.scenario-card');
    console.log('[Scenarios] Found', scenarioCards.length, 'scenario cards');
    
    scenarioCards.forEach(card => {
        card.addEventListener('click', () => {
            const scenario = card.getAttribute('data-scenario');
            console.log('[Event] Scenario clicked:', scenario);
            
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            document.getElementById('scenarioInput').value = scenario;
            
            const customCriteriaBox = document.getElementById('customCriteriaBox');
            if (customCriteriaBox) {
                if (scenario === 'custom') {
                    customCriteriaBox.style.display = 'block';
                } else {
                    customCriteriaBox.style.display = 'none';
                }
            }
        });
    });

    // –ü—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
    const customCriteriaField = document.getElementById('customCriteria');
    if (customCriteriaField) {
        customCriteriaField.addEventListener('input', () => {
            if (customCriteriaField.value.trim().length > 0) {
                document.getElementById('scenarioInput').value = 'custom';
                document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
                const customCard = document.querySelector('[data-scenario="custom"]');
                if (customCard) customCard.classList.add('selected');
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', (e) => {
            console.log('[Submit] Form submitted');
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            fetch('{{ url_for("analyze") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('[Response]', data);
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑';
                }
            })
            .catch(error => {
                console.error('[Error]', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑';
            });
        });
    }
});

// PWA Handlers (–≤–Ω–µ DOMContentLoaded)
// deferredPrompt —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤ pwa-install.js, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë

const pwaInstallBtn = document.getElementById('pwaInstallButtonHeader');
if (pwaInstallBtn) {
    pwaInstallBtn.addEventListener('click', async () => {
        if (typeof deferredPrompt !== 'undefined' && deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('PWA install:', outcome);
            deferredPrompt = null;
            document.getElementById('pwaInstallBanner').classList.add('hidden');
        }
    });
}

window.addEventListener('appinstalled', (e) => {
    console.log('PWA app installed');
    document.getElementById('pwaInstallBanner').classList.add('hidden');
});
</script>
{% endif %}
{% endblock %}
