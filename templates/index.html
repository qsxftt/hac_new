{% extends "base.html" %}

{% block title %}Главная - AI Тренер{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    .upload-zone {
        border: 3px dashed #007bff;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }
    .upload-zone:hover {
        background: #e9ecef;
        border-color: #0056b3;
    }
    .upload-zone.dragover {
        background: #d1ecf1;
        border-color: #17a2b8;
    }
    .scenario-card {
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .scenario-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .scenario-card.selected {
        border-color: #007bff;
        background-color: #e7f3ff;
    }
    .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}

{% if current_user.is_authenticated %}
<!-- Для авторизованных пользователей - форма загрузки -->

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-upload"></i> Загрузить видео
        </h1>

        <form id="uploadForm" method="POST" action="{{ url_for('analyze') }}" enctype="multipart/form-data">
            <!-- Зона загрузки -->
            <div class="upload-zone mb-4" id="uploadZone">
                <input type="file" 
                       name="video" 
                       id="videoInput" 
                       accept=".mp4,.avi,.mov,.mkv,.webm" 
                       style="display: none;" 
                       required>
                <i class="fas fa-cloud-upload-alt feature-icon text-primary"></i>
                <h4>Перетащите видео сюда</h4>
                <p class="text-muted mb-3">или нажмите для выбора файла</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('videoInput').click()">
                    <i class="fas fa-folder-open"></i> Выбрать файл
                </button>
                <p class="text-muted small mt-3 mb-0">
                    Поддерживаемые форматы: MP4, AVI, MOV, MKV, WebM (макс. 100 МБ)
                </p>
            </div>

            <!-- Выбранный файл -->
            <div id="fileInfo" class="alert alert-info" style="display: none;">
                <i class="fas fa-file-video"></i> 
                <strong>Выбран файл:</strong> <span id="fileName"></span>
                <button type="button" class="btn-close float-end" onclick="clearFile()"></button>
            </div>

            <!-- Выбор сценария -->
            <h4 class="mb-3">
                <i class="fas fa-tasks"></i> Выберите тип выступления:
            </h4>

            <input type="hidden" name="scenario" id="scenarioInput" value="academic">

            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card scenario-card selected" data-scenario="academic">
                        <div class="card-body text-center">
                            <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                            <h5>Академические работы</h5>
                            <p class="text-muted small">Защита дипломов, курсовых, диссертаций</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card scenario-card" data-scenario="project">
                        <div class="card-body text-center">
                            <i class="fas fa-project-diagram fa-3x text-success mb-3"></i>
                            <h5>Защита проекта</h5>
                            <p class="text-muted small">Презентация стартапа, бизнес-проекта</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card scenario-card" data-scenario="hackathon">
                        <div class="card-body text-center">
                            <i class="fas fa-rocket fa-3x text-warning mb-3"></i>
                            <h5>Хакатон/питч</h5>
                            <p class="text-muted small">Короткие презентации, питчинг идеи</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card scenario-card" data-scenario="public">
                        <div class="card-body text-center">
                            <i class="fas fa-microphone fa-3x text-info mb-3"></i>
                            <h5>Публичное выступление</h5>
                            <p class="text-muted small">Доклады, презентации, лекции</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom критерии -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="customCriteriaToggle">
                        <label class="form-check-label" for="customCriteriaToggle">
                            <strong>Использовать свои критерии оценки</strong>
                        </label>
                    </div>
                    <div id="customCriteriaBox" style="display: none;" class="mt-3">
                        <label for="customCriteria" class="form-label">
                            Введите свои критерии (каждый с новой строки):
                        </label>
                        <textarea class="form-control" 
                                  name="custom_criteria" 
                                  id="customCriteria" 
                                  rows="5" 
                                  placeholder="Например:&#10;1. Структура выступления&#10;2. Аргументация&#10;3. Контакт с аудиторией"></textarea>
                    </div>
                </div>
            </div>

            <!-- Кнопка отправки -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                    <i class="fas fa-paper-plane"></i> Начать анализ
                </button>
            </div>
        </form>
    </div>
</div>

{% else %}
<!-- Для неавторизованных - landing page -->

<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 mb-4">
            <i class="fas fa-microphone-alt"></i> AI Тренер Выступлений
        </h1>
        <p class="lead mb-4">
            Загрузите видео своего выступления и получите детальный анализ речи и структуры
        </p>
        <div class="d-flex gap-3 justify-content-center">
            <a href="{{ url_for('auth.register') }}" class="btn btn-light btn-lg">
                <i class="fas fa-user-plus"></i> Регистрация
            </a>
            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light btn-lg">
                <i class="fas fa-sign-in-alt"></i> Вход
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-video feature-icon text-primary"></i>
            <h4>Загрузите видео</h4>
            <p class="text-muted">Поддержка всех популярных форматов</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-brain feature-icon text-success"></i>
            <h4>AI анализ</h4>
            <p class="text-muted">Темп, паузы, слова-паразиты</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-chart-line feature-icon text-warning"></i>
            <h4>Детальные графики</h4>
            <p class="text-muted">Визуализация всех метрик</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="text-center">
            <i class="fas fa-dumbbell feature-icon text-info"></i>
            <h4>Упражнения</h4>
            <p class="text-muted">Персональные рекомендации</p>
        </div>
    </div>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
{% if current_user.is_authenticated %}
<script>
// Обработка выбора файла
const videoInput = document.getElementById('videoInput');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const submitBtn = document.getElementById('submitBtn');
const uploadZone = document.getElementById('uploadZone');

// Клик по зоне загрузки
uploadZone.addEventListener('click', () => {
    videoInput.click();
});

// Выбор файла
videoInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        fileName.textContent = file.name;
        fileInfo.style.display = 'block';
        submitBtn.disabled = false;
    }
});

// Drag & Drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    if (e.dataTransfer.files.length > 0) {
        videoInput.files = e.dataTransfer.files;
        const file = e.dataTransfer.files[0];
        fileName.textContent = file.name;
        fileInfo.style.display = 'block';
        submitBtn.disabled = false;
    }
});

// Очистка файла
function clearFile() {
    videoInput.value = '';
    fileInfo.style.display = 'none';
    submitBtn.disabled = true;
}

// Выбор сценария
document.querySelectorAll('.scenario-card').forEach(card => {
    card.addEventListener('click', () => {
        // Убираем выделение со всех карточек
        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
        
        // Выделяем выбранную
        card.classList.add('selected');
        
        // Обновляем скрытое поле
        const scenario = card.getAttribute('data-scenario');
        document.getElementById('scenarioInput').value = scenario;
        
        // Если выбран custom, показываем поле для критериев
        if (scenario === 'custom') {
            document.getElementById('customCriteriaToggle').checked = true;
            document.getElementById('customCriteriaBox').style.display = 'block';
        }
    });
});

// Переключатель custom критериев
document.getElementById('customCriteriaToggle').addEventListener('change', (e) => {
    if (e.target.checked) {
        document.getElementById('customCriteriaBox').style.display = 'block';
        document.getElementById('scenarioInput').value = 'custom';
        
        // Убираем выделение с других карточек
        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
    } else {
        document.getElementById('customCriteriaBox').style.display = 'none';
        
        // Возвращаем выделение на academic
        document.querySelector('[data-scenario="academic"]').classList.add('selected');
        document.getElementById('scenarioInput').value = 'academic';
    }
});

// Обработка отправки формы
document.getElementById('uploadForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // Показываем индикатор загрузки
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
    
    // Отправляем через fetch
    fetch('{{ url_for("analyze") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirect) {
            // Перенаправляем на страницу обработки
            window.location.href = data.redirect;
        } else if (data.error) {
            alert('Ошибка: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Начать анализ';
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при загрузке видео');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Начать анализ';
    });
});
</script>
{% endif %}
{% endblock %}
