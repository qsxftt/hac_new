{% extends "base.html" %}

{% block title %}Обработка видео - AI Тренер{% endblock %}

{% block extra_css %}
<style>
    .processing-container {
        max-width: 600px;
        margin: 4rem auto;
        text-align: center;
    }
    .progress-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: conic-gradient(#007bff 0%, #e9ecef 0%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 2rem auto;
        position: relative;
    }
    .progress-inner {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .status-message {
        font-size: 1.1rem;
        color: #666;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="processing-container">
    <h1 class="mb-4">
        <i class="fas fa-cog fa-spin"></i> Анализ видео
    </h1>
    
    <div class="progress-circle" id="progressCircle">
        <div class="progress-inner">
            <div class="spinner"></div>
            <h2 id="progressPercent">0%</h2>
        </div>
    </div>
    
    <p class="status-message" id="statusMessage">
        Инициализация...
    </p>
    
    <div class="alert alert-info mt-4" role="alert">
        <i class="fas fa-info-circle"></i>
        <strong>Это может занять несколько минут.</strong><br>
        Не закрывайте эту страницу.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const taskId = "{{ task_id }}";
const progressCircle = document.getElementById('progressCircle');
const progressPercent = document.getElementById('progressPercent');
const statusMessage = document.getElementById('statusMessage');

function updateProgress(percent) {
    progressPercent.textContent = percent + '%';
    const degrees = (percent / 100) * 360;
    progressCircle.style.background = `conic-gradient(#007bff ${degrees}deg, #e9ecef 0deg)`;
}

function checkStatus() {
    fetch(`/status/${taskId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Status:', data);
            
            // Обновляем прогресс
            if (data.progress !== undefined) {
                updateProgress(data.progress);
            }
            
            // Обновляем сообщение
            if (data.message) {
                statusMessage.textContent = data.message;
            }
            
            // Проверяем статус
            if (data.status === 'completed') {
                // Успех! Перенаправляем на результаты
                statusMessage.textContent = '✅ Анализ завершен! Перенаправление...';
                statusMessage.classList.add('text-success');
                
                setTimeout(() => {
                    // Формируем URL на стороне клиента
                    window.location.href = `/results/${data.analysis_id}`;
                }, 1000);
                
            } else if (data.status === 'error') {
                // Ошибка
                statusMessage.textContent = '❌ ' + (data.message || 'Произошла ошибка');
                statusMessage.classList.add('text-danger');
                
                // Показываем кнопку возврата
                setTimeout(() => {
                    const container = document.querySelector('.processing-container');
                    container.innerHTML += `
                        <div class="mt-4">
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-redo"></i> Попробовать снова
                            </a>
                            <a href="/history" class="btn btn-secondary">
                                <i class="fas fa-history"></i> История
                            </a>
                        </div>
                    `;
                }, 2000);
                
            } else if (data.status === 'not_found') {
                // Задача не найдена
                statusMessage.textContent = '⚠️ Задача не найдена';
                statusMessage.classList.add('text-warning');
                
            } else {
                // Продолжаем опрашивать
                setTimeout(checkStatus, 2000);
            }
        })
        .catch(error => {
            console.error('Ошибка проверки статуса:', error);
            statusMessage.textContent = '⚠️ Ошибка связи с сервером. Повторная попытка...';
            setTimeout(checkStatus, 3000);
        });
}

// Начинаем проверку статуса
checkStatus();
</script>
{% endblock %}
