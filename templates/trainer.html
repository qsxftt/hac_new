{% extends "base.html" %}

{% block title %}–¢—Ä–µ–Ω–∞–∂–µ—Ä - AI –¢—Ä–µ–Ω–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .exercise-card {
        transition: all 0.3s ease;
    }
    .exercise-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .badge {
        font-size: 0.85rem;
    }
    .ai-plan-content h1 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    }
    .ai-plan-content h2 {
        font-size: 1.25rem;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: #2c3e50;
    }
    .ai-plan-content p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-dumbbell"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</h1>
            <p class="text-muted">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–¥–æ–±—Ä–∞–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>
        </div>
    </div>

    <!-- –ù–û–í–û–ï: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
    {% if metrics %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> üìä –ü–æ—á–µ–º—É —ç—Ç–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è?</h5>
                <p class="mb-2">–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —è –ø–æ–¥–æ–±—Ä–∞–ª —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥:</p>
                <ul class="mb-0">
                    {% if metrics.avg_tempo and (metrics.avg_tempo > 5 or metrics.avg_tempo < 2) %}
                    <li><strong>–¢–µ–º–ø —Ä–µ—á–∏:</strong> 
                        {% if metrics.avg_tempo > 5 %}
                            –¢—ã –≥–æ–≤–æ—Ä–∏—à—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ ({{ metrics.avg_tempo|round(1) }} —Å–ª–æ–≤/—Å–µ–∫). –ù—É–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è.
                        {% else %}
                            –¢—ã –≥–æ–≤–æ—Ä–∏—à—å —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ ({{ metrics.avg_tempo|round(1) }} —Å–ª–æ–≤/—Å–µ–∫). –ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è.
                        {% endif %}
                    </li>
                    {% endif %}
                    
                    {% if metrics.pauses_count and metrics.pauses_count > 5 %}
                    <li><strong>–ü–∞—É–∑—ã:</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {{ metrics.pauses_count }} –¥–ª–∏–Ω–Ω—ã—Ö –ø–∞—É–∑. –†–∞–±–æ—Ç–∞–π –Ω–∞–¥ –ø–ª–∞–≤–Ω–æ—Å—Ç—å—é —Ä–µ—á–∏.</li>
                    {% endif %}
                    
                    {% if metrics.filler_words_count and metrics.filler_words_count > 7 %}
                    <li><strong>–°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã:</strong> –ù–∞–π–¥–µ–Ω–æ {{ metrics.filler_words_count }} —Å–ª–æ–≤-–ø–∞—Ä–∞–∑–∏—Ç–æ–≤ ("—ç—ç—ç", "–Ω—É—É"). –ó–∞–º–µ–Ω—è–π –Ω–∞ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –ø–∞—É–∑—ã.</li>
                    {% endif %}
                    
                    {% if metrics.repetitions_count and metrics.repetitions_count > 5 %}
                    <li><strong>–ü–æ–≤—Ç–æ—Ä—ã —Å–ª–æ–≤:</strong> {{ metrics.repetitions_count }} —Å–ª–æ–≤ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–Ω–æ–Ω–∏–º—ã.</li>
                    {% endif %}
                    
                    <!-- –ù–û–í–û–ï: –ê—É–¥–∏–æ –º–µ—Ç—Ä–∏–∫–∏ -->
                    {% if metrics.audio_features %}
                    {% set audio = metrics.audio_features %}
                    
                    {% if audio.energy_score and audio.energy_score < 40 %}
                    <li><strong>üé§ –≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏:</strong> –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è ({{ audio.energy_score|round(1) }}/100). –¢–≤–æ—è —Ä–µ—á—å –∑–≤—É—á–∏—Ç –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ –∏ —Ç–∏—Ö–æ. –ü—Ä–∞–∫—Ç–∏–∫—É–π –¥—ã—Ö–∞–Ω–∏–µ –∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é!</li>
                    {% elif audio.energy_score and audio.energy_score < 60 %}
                    <li><strong>üé§ –≠–Ω–µ—Ä–≥–∏—è —Ä–µ—á–∏:</strong> –°—Ä–µ–¥–Ω—è—è ({{ audio.energy_score|round(1) }}/100). –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —ç–º–æ—Ü–∏–π –∏ –≤–∞—Ä–∏–∞—Ü–∏–∏.</li>
                    {% endif %}
                    
                    {% if audio.avg_volume and audio.avg_volume < 30 %}
                    <li><strong>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å:</strong> –°–ª–∏—à–∫–æ–º —Ç–∏—Ö–∏–π –≥–æ–ª–æ—Å ({{ audio.avg_volume|round(1) }}%). –†–∞–±–æ—Ç–∞–π –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ü–∏–µ–π –≥–æ–ª–æ—Å–∞ –∏ –¥—ã—Ö–∞–Ω–∏–µ–º –¥–∏–∞—Ñ—Ä–∞–≥–º–æ–π.</li>
                    {% elif audio.avg_volume and audio.avg_volume < 50 %}
                    <li><strong>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å:</strong> –¢–∏—Ö–∏–π –≥–æ–ª–æ—Å ({{ audio.avg_volume|round(1) }}%). –ü–æ–ø—Ä–æ–±—É–π –≥–æ–≤–æ—Ä–∏—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–µ–µ.</li>
                    {% endif %}
                    
                    {% if audio.pitch_variance and audio.pitch_variance < 200 %}
                    <li><strong>üéµ –ò–Ω—Ç–æ–Ω–∞—Ü–∏—è:</strong> –ú–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è —Ä–µ—á—å. –ú–µ–Ω—è–π –≤—ã—Å–æ—Ç—É –≥–æ–ª–æ—Å–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–∞!</li>
                    {% endif %}
                    
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é -->
    {% if ai_plan %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-week"></i> –ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é</h5>
                </div>
                <div class="card-body">
                    <div class="ai-plan-content">{{ ai_plan|safe }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-tasks"></i> –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h4>
        </div>
    </div>

    <div class="row">
        {% if exercises %}
        {% for exercise in exercises %}
        <div class="col-md-6 mb-4">
            <div class="card exercise-card h-100 border-{% if exercise.difficulty == 'beginner' %}success{% elif exercise.difficulty == 'intermediate' %}warning{% else %}danger{% endif %}">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é -->
                <div class="card-header bg-light">
                    <span class="badge bg-{% if exercise.category == 'breathing' %}primary{% elif exercise.category == 'intonation' %}info{% elif exercise.category == 'tempo' %}warning{% elif exercise.category == 'diction' %}success{% elif exercise.category == 'pauses' %}secondary{% elif exercise.category == 'filler_words' %}danger{% else %}dark{% endif %}">
                        {% if exercise.category == 'breathing' %}
                            ü´Å –î—ã—Ö–∞–Ω–∏–µ
                        {% elif exercise.category == 'intonation' %}
                            üéµ –ò–Ω—Ç–æ–Ω–∞—Ü–∏—è
                        {% elif exercise.category == 'tempo' %}
                            ‚è±Ô∏è –¢–µ–º–ø
                        {% elif exercise.category == 'pauses' %}
                            ‚è∏Ô∏è –ü–∞—É–∑—ã
                        {% elif exercise.category == 'filler_words' %}
                            üí¨ –°–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã
                        {% elif exercise.category == 'diction' %}
                            üó£Ô∏è –î–∏–∫—Ü–∏—è
                        {% elif exercise.category == 'practice' %}
                            üìù –ü—Ä–∞–∫—Ç–∏–∫–∞
                        {% elif exercise.category == 'repetitions' %}
                            üîÅ –ü–æ–≤—Ç–æ—Ä—ã
                        {% else %}
                            üìù {{ exercise.category }}
                        {% endif %}
                    </span>
                    <span class="badge bg-{% if exercise.difficulty == 'beginner' %}success{% elif exercise.difficulty == 'intermediate' %}warning{% else %}danger{% endif %} float-end">
                        {% if exercise.difficulty == 'beginner' %}
                            üü¢ –ù–æ–≤–∏—á–æ–∫
                        {% elif exercise.difficulty == 'intermediate' %}
                            üü° –°—Ä–µ–¥–Ω–∏–π
                        {% else %}
                            üî¥ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
                        {% endif %}
                    </span>
                </div>
                
                <div class="card-body">
                    <h5 class="card-title">{{ exercise.title }}</h5>
                    <p class="card-text text-muted">{{ exercise.description }}</p>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="far fa-clock"></i> {{ exercise.duration_minutes }} –º–∏–Ω—É—Ç
                        </small>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#instructions-{{ exercise.id }}">
                        <i class="fas fa-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    </button>
                    
                    <!-- –°–≤–µ—Ä–Ω—É—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
                    <div class="collapse mt-3" id="instructions-{{ exercise.id }}">
                        <div class="alert alert-light">
                            <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong>
                            <p style="white-space: pre-line;">{{ exercise.instructions }}</p>
                            
                            {% if exercise.practice_text %}
                            <hr>
                            <strong>üìù –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏:</strong>
                            <p class="fst-italic">"{{ exercise.practice_text }}"</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–í—ã–ø–æ–ª–Ω–µ–Ω–æ" -->
                    <form method="POST" action="{{ url_for('complete_exercise', analysis_id=analysis_id, exercise_id=exercise.id) }}" class="mt-3">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
    <div class="row mt-4 mb-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('results', analysis_id=analysis_id) }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            </a>
            <a href="{{ url_for('progress') }}" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-chart-line"></i> –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 3000);
    });
});
</script>
{% endblock %}
